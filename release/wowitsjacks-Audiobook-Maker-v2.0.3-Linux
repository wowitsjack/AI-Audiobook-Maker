#!/bin/bash

# wowitsjack's Audiobook Maker v2.0.3 - Linux Launcher
# This script sets up the environment and runs the audiobook generator

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "üéß wowitsjack's Audiobook Maker v2.0.3 - Linux Launcher"
echo "======================================================="

# Check if Python 3 is installed
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 is required but not installed."
    echo "Please install Python 3 from your package manager:"
    echo "  Ubuntu/Debian: sudo apt install python3 python3-pip python3-venv"
    echo "  Fedora/RHEL:   sudo dnf install python3 python3-pip"
    echo "  Arch:          sudo pacman -S python python-pip"
    echo "Press any key to exit..."
    read -n 1
    exit 1
fi

# Check if we're in the project directory
if [ ! -f "$PROJECT_DIR/audiobook_gui.py" ]; then
    echo "‚ùå Could not find audiobook_gui.py"
    echo "Please ensure this launcher is in the project directory"
    echo "Press any key to exit..."
    read -n 1
    exit 1
fi

echo "üìÇ Project directory: $PROJECT_DIR"
cd "$PROJECT_DIR"

# Check if virtual environment exists
if [ ! -d "venv" ]; then
    echo "üîß Setting up virtual environment..."
    python3 -m venv venv
    
    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to create virtual environment"
        echo "Please install python3-venv package:"
        echo "  Ubuntu/Debian: sudo apt install python3-venv"
        echo "Press any key to exit..."
        read -n 1
        exit 1
    fi
fi

# Activate virtual environment
echo "üöÄ Activating virtual environment..."
source venv/bin/activate

# Install/upgrade dependencies
echo "üì¶ Installing dependencies..."
pip install --quiet --upgrade pip
pip install --quiet -r requirements.txt

if [ $? -ne 0 ]; then
    echo "‚ùå Failed to install dependencies"
    echo "Please check your internet connection and try again"
    echo "Press any key to exit..."
    read -n 1
    exit 1
fi

# Check for .env file
if [ ! -f ".env" ]; then
    echo "‚ö†Ô∏è  No .env file found!"
    echo "Please create a .env file with your Google API key:"
    echo "GOOGLE_API_KEY=your_api_key_here"
    echo "NARRATOR_VOICE=Kore"
    echo "TTS_MODEL=gemini-2.5-pro-preview-tts"
    echo ""
    echo "Press any key to continue anyway..."
    read -n 1
fi

# Launch the application
echo "üéß Starting wowitsjack's Audiobook Maker v2.0.3..."
echo ""
python audiobook_gui.py

# Deactivate virtual environment
deactivate

echo ""
echo "‚úÖ Application closed. Press any key to exit..."
read -n 1